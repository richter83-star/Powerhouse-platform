name: Frontend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/app/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend/app
      run: npm ci
    
    - name: Run linter
      working-directory: ./frontend/app
      run: npm run lint || true
    
    - name: Type check
      working-directory: ./frontend/app
      continue-on-error: true
      run: npx tsc --noEmit
    
    - name: Build
      working-directory: ./frontend/app
      run: npm run build
      env:
        SKIP_ENV_VALIDATION: true
        DATABASE_URL: postgresql://test:test@localhost:5432/test
        NEXTAUTH_URL: http://localhost:3000
        NEXTAUTH_SECRET: test-secret-for-ci
        NEXT_PUBLIC_API_URL: http://localhost:8000

  openapi-drift:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4

    - name: Detect backend API changes
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          backend_api:
            - 'backend/api/**'

    - name: Skip drift check (no API changes)
      if: steps.changes.outputs.backend_api != 'true'
      run: echo "No backend API changes detected; skipping OpenAPI drift check."

    - name: Set up Python
      if: steps.changes.outputs.backend_api == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install backend dependencies
      if: steps.changes.outputs.backend_api == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Generate OpenAPI schema
      if: steps.changes.outputs.backend_api == 'true'
      run: |
        python - <<'PY'
        import json
        import sys

        sys.path.insert(0, "backend")
        from api.main import app

        with open("/tmp/openapi.json", "w") as handle:
            json.dump(app.openapi(), handle, indent=2, sort_keys=True)
        PY

    - name: Set up Node.js
      if: steps.changes.outputs.backend_api == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/app/package-lock.json

    - name: Install frontend dependencies
      if: steps.changes.outputs.backend_api == 'true'
      working-directory: ./frontend/app
      run: npm ci

    - name: Generate API types
      if: steps.changes.outputs.backend_api == 'true'
      working-directory: ./frontend/app
      env:
        OPENAPI_SCHEMA: /tmp/openapi.json
      run: npm run generate:api

    - name: Check for OpenAPI drift
      if: steps.changes.outputs.backend_api == 'true'
      run: git diff --exit-code frontend/app/lib/api-types.ts

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/app/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend/app
      run: npm ci
    
    - name: Run npm audit
      working-directory: ./frontend/app
      run: npm audit --audit-level=moderate || true

